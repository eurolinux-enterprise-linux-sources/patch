diff -up patch-2.7.1/src/pch.c.CVE-2018-1000156 patch-2.7.1/src/pch.c
--- patch-2.7.1/src/pch.c.CVE-2018-1000156	2012-09-22 19:44:33.000000000 +0200
+++ patch-2.7.1/src/pch.c	2018-04-13 22:19:04.509532690 +0200
@@ -31,6 +31,7 @@
 #if HAVE_SETMODE_DOS
 # include <io.h>
 #endif
+#include <sys/wait.h>
 
 #define INITHUNKMAX 125			/* initial dynamic allocation size */
 
@@ -2381,22 +2382,28 @@ do_ed_script (char const *inname, char c
     static char const editor_program[] = EDITOR_PROGRAM;
 
     file_offset beginning_of_this_line;
-    FILE *pipefp = 0;
     size_t chars_read;
+    FILE *tmpfp = 0;
+    char const *tmpname;
+    int tmpfd = -1;
+    pid_t pid;
+
+    if (! dry_run && ! skip_rest_of_patch)
+      {
+       /* Write ed script to a temporary file.  This causes ed to abort on
+          invalid commands such as when line numbers or ranges exceed the
+          number of available lines.  When ed reads from a pipe, it rejects
+          invalid commands and treats the next line as a new command, which
+          can lead to arbitrary command execution.  */
+
+       tmpfd = make_tempfile (&tmpname, 'e', NULL, O_RDWR | O_BINARY, 0);
+       if (tmpfd == -1)
+         pfatal ("Can't create temporary file %s", quotearg (tmpname));
+       tmpfp = fdopen (tmpfd, "w+b");
+       if (! tmpfp)
+         pfatal ("Can't open stream for file %s", quotearg (tmpname));
+      }
 
-    if (! dry_run && ! skip_rest_of_patch) {
-	int exclusive = *outname_needs_removal ? 0 : O_EXCL;
-	assert (! inerrno);
-	*outname_needs_removal = true;
-	copy_file (inname, outname, 0, exclusive, instat.st_mode, true);
-	sprintf (buf, "%s %s%s", editor_program,
-		 verbosity == VERBOSE ? "" : "- ",
-		 outname);
-	fflush (stdout);
-	pipefp = popen(buf, binary_transput ? "wb" : "w");
-	if (!pipefp)
-	  pfatal ("Can't open pipe to %s", quotearg (buf));
-    }
     for (;;) {
 	char ed_command_letter;
 	beginning_of_this_line = file_tell (pfp);
@@ -2407,14 +2414,14 @@ do_ed_script (char const *inname, char c
 	}
 	ed_command_letter = get_ed_command_letter (buf);
 	if (ed_command_letter) {
-	    if (pipefp)
-		if (! fwrite (buf, sizeof *buf, chars_read, pipefp))
+	    if (tmpfp)
+		if (! fwrite (buf, sizeof *buf, chars_read, tmpfp))
 		    write_fatal ();
 	    if (ed_command_letter != 'd' && ed_command_letter != 's') {
 	        p_pass_comments_through = true;
 		while ((chars_read = get_line ()) != 0) {
-		    if (pipefp)
-			if (! fwrite (buf, sizeof *buf, chars_read, pipefp))
+		    if (tmpfp)
+			if (! fwrite (buf, sizeof *buf, chars_read, tmpfp))
 			    write_fatal ();
 		    if (chars_read == 2  &&  strEQ (buf, ".\n"))
 			break;
@@ -2427,13 +2434,50 @@ do_ed_script (char const *inname, char c
 	    break;
 	}
     }
-    if (!pipefp)
+    if (!tmpfp)
       return;
-    if (fwrite ("w\nq\n", sizeof (char), (size_t) 4, pipefp) == 0
-	|| fflush (pipefp) != 0)
+    if (fwrite ("w\nq\n", sizeof (char), (size_t) 4, tmpfp) == 0
+	|| fflush (tmpfp) != 0)
       write_fatal ();
-    if (pclose (pipefp) != 0)
-      fatal ("%s FAILED", editor_program);
+
+    if (lseek (tmpfd, 0, SEEK_SET) == -1)
+      pfatal ("Can't rewind to the beginning of file %s", quotearg (tmpname));
+
+    if (! dry_run && ! skip_rest_of_patch) {
+       int exclusive = *outname_needs_removal ? 0 : O_EXCL;
+       *outname_needs_removal = true;
+       if (inerrno != ENOENT)
+         {
+           *outname_needs_removal = true;
+           copy_file (inname, outname, 0, exclusive, instat.st_mode, true);
+         }
+       sprintf (buf, "%s %s%s", editor_program,
+                verbosity == VERBOSE ? "" : "- ",
+                outname);
+       fflush (stdout);
+
+       pid = fork();
+       if (pid == -1)
+         pfatal ("Can't fork");
+       else if (pid == 0)
+         {
+           dup2 (tmpfd, 0);
+           execl ("/bin/sh", "sh", "-c", buf, (char *) 0);
+           _exit (2);
+         }
+       else
+         {
+           int wstatus;
+           if (waitpid (pid, &wstatus, 0) == -1
+               || ! WIFEXITED (wstatus)
+               || WEXITSTATUS (wstatus) != 0)
+             fatal ("%s FAILED", editor_program);
+         }
+    }
+
+    fclose (tmpfp);
+    unlink (tmpname);
+    free((char*) tmpname);
 
     if (ofp)
       {
diff -up patch-2.7.1/tests/ed-style.CVE-2018-1000156 patch-2.7.1/tests/ed-style
--- patch-2.7.1/tests/ed-style.CVE-2018-1000156	2018-04-13 22:17:57.367258994 +0200
+++ patch-2.7.1/tests/ed-style	2018-04-13 22:17:57.367258994 +0200
@@ -0,0 +1,40 @@
+# Copyright (C) 2018 Free Software Foundation, Inc.
+#
+# Copying and distribution of this file, with or without modification,
+# in any medium, are permitted without royalty provided the copyright
+# notice and this notice are preserved.
+
+. $srcdir/test-lib.sh
+
+require_cat
+use_local_patch
+use_tmpdir
+
+# ==============================================================
+
+cat > ed1.diff <<EOF
+0a
+foo
+.
+EOF
+
+check 'patch -e foo -i ed1.diff' <<EOF
+EOF
+
+check 'cat foo' <<EOF
+foo
+EOF
+
+cat > ed2.diff <<EOF
+1337a
+r !echo bar
+,p
+EOF
+
+check 'patch -e foo -i ed2.diff 2> /dev/null || echo "Status: $?"' <<EOF
+Status: 2
+EOF
+
+check 'cat foo' <<EOF
+foo
+EOF
diff -up patch-2.7.1/tests/Makefile.am.CVE-2018-1000156 patch-2.7.1/tests/Makefile.am
--- patch-2.7.1/tests/Makefile.am.CVE-2018-1000156	2018-04-13 22:17:57.360258966 +0200
+++ patch-2.7.1/tests/Makefile.am	2018-04-13 22:17:57.367258994 +0200
@@ -28,6 +28,7 @@ TESTS = \
 	criss-cross \
 	crlf-handling \
 	dash-o-append \
+	ed-style \
 	empty-files \
 	fifo \
 	file-modes \
diff -up patch-2.7.1/tests/Makefile.in.orig patch-2.7.1/tests/Makefile.in
--- patch-2.7.1/tests/Makefile.in.orig	2018-04-13 22:24:23.758796422 +0200
+++ patch-2.7.1/tests/Makefile.in	2018-04-13 22:26:09.860216420 +0200
@@ -1083,6 +1083,7 @@ TESTS = \
 	criss-cross \
 	crlf-handling \
 	dash-o-append \
+	ed-style \
 	empty-files \
 	fifo \
 	file-modes \
@@ -1310,6 +1311,8 @@ crlf-handling.log: crlf-handling
 	@p='crlf-handling'; $(am__check_pre) $(LOG_COMPILE) "$$tst" $(am__check_post)
 dash-o-append.log: dash-o-append
 	@p='dash-o-append'; $(am__check_pre) $(LOG_COMPILE) "$$tst" $(am__check_post)
+ed-style.log: ed-style
+	@p='ed-style'; $(am__check_pre) $(LOG_COMPILE) "$$tst" $(am__check_post)
 empty-files.log: empty-files
 	@p='empty-files'; $(am__check_pre) $(LOG_COMPILE) "$$tst" $(am__check_post)
 fifo.log: fifo
